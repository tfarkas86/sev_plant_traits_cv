---
title: "Sev Plant Summary"
author: "Tim Farkas"
date: "4/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r Load Libraries}
library(tidyverse)
library(ape)
library(geiger)
```


##### Modify Trait Data For Analysis 
```{r Data Input and Prep}
raw_traits <- read_csv("./Data/sev_all_traits_Nov2018.csv") %>%
  filter(! kartez %in% c("DAJA?")) %>% # just not sure about this ID, plust not much data
  mutate_at(vars(kartez), funs(ifelse(. == "ARPU9", "ARIST", .))) %>% # lump big Aristida under ARIST
  mutate_at(vars(kartez), funs(ifelse(. %in% c("SPCO4", "SPFL2"), "SPORO", .))) %>% # lump Sporobolus 
  mutate_at(vars(kartez), funs(ifelse(. %in% c("ASFE2", "ASNU4"), "ASTRA", .))) %>% # lump Astragalus
  mutate_at(vars(a_p), funs(ifelse(. == "a", 0, 1))) %>% # numeric annual vs. perennial
  group_by(kartez) 

all_traits <- 
  # now there are duplicate kartez codes, so summarize
  inner_join(raw_traits %>% summarize_at(vars(family:apgf, -a_p), funs(max)),
             raw_traits %>% summarize_at(vars(a_p, avg.height_A:seed_mass), funs(mean)), 
             by = "kartez") %>% 
  # remove outliers
  mutate_at(vars(lma), funs(ifelse(. > 0.1, NA, .))) %>%
  mutate_at(vars(p95.height_A), funs(ifelse(. > 100, NA, .))) %>%
  mutate_at(vars(sdens), funs(ifelse(. > 0.003, NA, .))) %>%
  mutate_at(vars(rdens), funs(ifelse(. > 0.003, NA, .))) %>%
  mutate_at(vars(fr.diam), funs(ifelse(. > 0.15, NA, .))) 

```

#### PICs

```{r Single Trait Pics Function}

pics <- function(x, # a tibble or data frame with trait data
                 trait, # a character string of a single trait column name
                 phy, # a phylogenetic tree of class "phylo" & order "cladewise"
                 taxa, # a character string of the taxon column, to match tips in phy
                 scale=TRUE) { # logical indicator whether to mean center PIC output
  
  require(ape)
  require(dplyr)

  #### modify data ####
  
    dd <- x %>%
      as_tibble() %>%
      select(taxa, trait) %>%
      filter(complete.cases(.)) %>% # filter complete cases
      as.data.frame() # to data frame in case of tibble
    # get row names for ape::pic function
    taxon.names <- dd[, taxa]
    
    # get trait values data frame
    traits <- dd[, trait, drop=FALSE]
    
    # assign row names
    rownames(traits) <- taxon.names
  
  #### modify tree ####   
    
    # prune tree and data and resolve mutichotomies
    pruned <- drop.tip(phy, setdiff(phy$tip.label, taxon.names)) %>%
      multi2di(phy, random=FALSE) 
    traits <- traits[! rownames(traits) %in% setdiff(phy$tip.label, taxon.names), , drop=FALSE]

    
    # label nodes
    pruned$node.label <- paste("node", 
                            formatC(c(1:pruned$Nnode), 
                                    digits=0, width=nchar(pruned$Nnode), flag="0"))
    
  #### apply pic function ####
    
    pic.out <- pic(x = set_names(traits[[1]], rownames(traits)), 
                   phy = pruned, 
                   scaled = scale, 
                   var.contrasts = TRUE)
    pic.out <- pic.out %>%
      as_tibble() %>%
      mutate(node = rownames(pic.out)) %>%
      mutate(pic_abs = abs(contrasts), 
             sd = sqrt(variance)) %>%
      select(node, pic=contrasts, pic_abs, var=variance, sd)
    
    return(pic.out)
    
}

```

```{r Find Transformation}

brl_transform <- function(x, # a tibble or data frame with trait data
                          trait, # a character string of trait column
                          phy, # a phylogenetic tree of class "phylo" & order "cladewise"
                          taxa, # a character string of the taxon column, to match tips in phy
                          scale=TRUE) {
  
  require(geiger)
  
  # No transformatin
  pic.raw <- list(pics(x=x, trait=trait, phy=phy, taxa=taxa, scale=scale) %>% 
                    mutate(trans = "raw"))
  
  # All equal
  pic.all1 <- list(pics(x=x, trait=trait, phy=compute.brlen(phy=phy, runif, min=0, max=1), 
                        taxa=taxa, scale=scale) %>%
                     mutate(trans="all1"))
  
  # Pagel transformations
  lambdas <- seq(0, .9, by=.1)  
  
  pic.pagel <- lapply(lambdas, function(l) {
    
    phy.pagel <- rescale(x=phy, model="lambda", l)
    pics(x=x, trait=trait, phy=phy.pagel, taxa=taxa, scale=scale) %>%
      as_tibble() %>%
      mutate(trans = paste("Pagel: lambda = ", l, sep=""))
    
  }) 
  
  names(pic.pagel) <- paste("Pagel: lambda = ", lambdas, sep="")
  
  # Grafen transformations
  rhos <- seq(.1, 1, by=.1)
  
  pic.grafen <- lapply(rhos, function(p) {
    
    phy.grafen <- compute.brlen(phy=phy, power=p)
    pics(x=x, trait=trait, phy=phy.grafen, taxa=taxa, scale=scale) %>%
      as_tibble() %>%
      mutate(trans = paste("Grafen: power = ", p, sep=""))
    
  }) 
  
  names(pic.grafen) <- paste("Grafen: power = ", lambdas, sep="")
  
  # combine into one list
  pics.out <- c(pic.raw=pic.raw, pic.all1=pic.all1, pic.pagel, pic.grafen)
  
  return(pics.out)
  
}


```

```{r Function Testing}
x <- all_traits 
trait <- "ldmc"
taxa="taxon.new"
phy <- read.tree("Data/sev_traits_tree101.tre")

# test single pic function
pics(x=all_traits, trait=trait, phy=read.tree("Data/sev_traits_tree101.tre"), taxa="taxon.new")
# test branch length transformation function
pics.ldmc <- brl_transform(x=all_traits, trait=trait, phy=read.tree("Data/sev_traits_tree101.tre"), taxa = "taxon.new")

```


```{r Visualize Transformations}

# get all trait names
trait_names <- all_traits %>%
  select(a_p:seed_mass) %>%
  names()

# loop through names to create diagnostic transformation plots
for(trait in trait_names[20]) {
  
  print(trait)
  
  # get pics for all transformations
  trait_pics <- brl_transform(x=all_traits, trait=trait, 
                              taxa = "taxon.new",
                              phy=read.tree("Data/sev_traits_tree101.tre"))
  
  # bind to single data frame
  trait.pics.df <- do.call(rbind, trait_pics) 
    # filter(!grepl("power", .$trans)) %>% # Pagel only
   
  # get correlations
  trait.cors <- trait.pics.df %>%
    group_by(trans) %>%
    summarize(cor=round(cor(pic_abs, sd), 2))
  
  # create diagnostic plot

  trait.pics.df %>%
    ggplot(aes(x=pic_abs, y=sd)) +
    geom_label(aes(label=substr(node, nchar(node) - 2, nchar(node))),
               cex=2.5) +
    facet_wrap(~ trans, scales = "free") + 
    geom_text(data = trait.cors, 
              aes(x=Inf, y=Inf, label=paste("r = ", trait.cors$cor, sep=""),
                  vjust=1, hjust=1),
              cex = 3, col="red")
  
  # write to disk
  ggsave(filename = paste("Figures/pic_trans_diagnostics_", trait, ".pdf", 
                          sep=""),
         device="pdf", height = 14, width=14)
  
}

```


