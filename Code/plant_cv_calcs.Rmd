---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r Load libraries}

library(tidyverse)

```


##### Biomass and CV
```{r Input/Modify/Explore Raw Biomass Data}
## Input raw data
  ab.raw <- read_csv("../Data/Sevilleta_allbiomass_28Jan2018.csv", 
                     col_types=cols(transect = col_character(),
                                    year = col_integer(), 
                                    web = col_character(), 
                                    quad = col_character())) # guessed logical

## modify data
ab <- ab.raw %>%
  filter(substr(site, 1, 4) == "core", treatment == "C") %>% # core sites only
  mutate(year_char =  paste("y", year, sep="")) %>% # make year values character
  # change and aggregate species when kartez change, or are difficult to identify
  mutate_at(vars(kartez), 
            funs(ifelse(. %in% c("ARDI5", "ARPU9"), "ARIST", 
                        ifelse(. %in% c("SPCO4", "SPFL2", "SPCR"), "SPORO", 
                               ifelse(. == "OESU3", "GACO5", 
                                      ifelse(. == "OESUN", "GASUN", 
                                             ifelse(. == "DYGR", "CHGR2", 
                                                    ifelse(. %in% c("ASFE2", "ASNU4", "ASTRA"), "ASTRA", .)))))))) %>%
  mutate_at(vars(site), # recode sites to simplify
            funs(recode(., "core_black" = "G", "core_creosote" = "C", 
                            "core_blue" = "B", "core_PJ" = "P" ))) %>%
  mutate_at(vars(season), # recode seasons to simplify
            funs(recode(., "fall" = "F", "spring" = "S"))) %>%
  mutate_at(vars(web), funs(ifelse(site == "P", transect, .))) %>%
  mutate(quad_id = paste(site, web, plot, quad, sep="_")) %>%
  select(site, year, year_char, season:quad, quad_id, kartez, biomass.BM:biomass.BIM,
         -treatment, -block, -subplot, -transect) %>%
  droplevels() # reset factor levels

```

```{r Biomass Exploration}

## match with traits species
sp.raw <- read_csv("../Data/sev_all_traits_Nov2018.csv") %>% 
  mutate_at(vars(kartez), funs(as_factor(.)))

quad.raw <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/Biomass/NPP_quad_20181105.csv") %>% 
  mutate_at(vars(Species), funs(as_factor(.)))

levels(ab$kartez)
levels(sp.raw$kartez)

intersect(sp.raw$kartez, levels(ab$kartez))
setdiff(sp.raw$kartez, levels(ab$kartez)) # only missing species have been aggregated = good
setdiff(levels(ab$kartez), sp.raw$kartez)
setdiff(sp.raw$kartez, levels(quad.raw$Species))
setdiff(levels(quad.raw$Species), sp.raw$kartez)

```

```{r Identify Skipped Quads}

# fill in all year*quad combinations with no data as 0s
ab %>% 
  filter(season == "F") %>%
  group_by(year, site, web, plot, quad) %>%
  summarize(n_records = n()) %>%
  ungroup() %>%
  complete(year, nesting(site, web, plot, quad), fill=list(n_records = 0)) %>%
  {. ->> "quad_counts"}

# get first and last year containing data for each quad
quad_counts %>%
  filter(n_records > 0) %>%
  group_by(site, web, plot, quad) %>%
  summarize(min_year = min(year), 
            max_year = max(year)) %>%
            {. ->> "start_end"}

# 156 quads with inconsistent sampling
start_end %>%
  filter(min_year > 2003 |
         max_year < 2017)

# filter out quads with inconsistent sampling
ab2 <- ab %>%
  semi_join(start_end %>%
              filter(min_year < 2004, 
                     max_year == 2017), 
            by=c("site", "web", "plot", "quad")) 

```


```{r Make CV data}
temp_cv <- ab %>%
  group_by(year, year_char, season, site, web, plot, quad, kartez) %>%
  summarize(density_BM = sum(biomass.BM) ,
            density_BIM = sum(biomass.BIM)) %>%
  complete(kartez, nesting(year, season, site), fill=list(density_BM = 0, 
                                                          density_BIM = 0)) %>%
  ungroup() %>% group_by(site, season, kartez) %>%
  summarize(cv_BM = sd(density_BM)/mean(density_BM),
            cv_BIM = sd(density_BIM)/mean(density_BIM)) %>%
  ungroup() %>%
  replace(is.na(.), NA) %>%
  gather(key = "cv_type", value = "density", starts_with("cv")) %>%
  unite(col = season_site_cv, season, site, cv_type, sep=".") %>%
  spread(key=season_site_cv, value=density) %>%
  rowwise() %>%
  mutate(# Fall Flats only average, Fall All sites average
    F.F.cv_BIM = mean(c(F.B.cv_BIM, F.C.cv_BIM, F.G.cv_BIM), na.rm=TRUE),
    F.F.cv_BM = mean(c(F.B.cv_BM, F.C.cv_BM, F.G.cv_BM), na.rm=TRUE),
    F.A.cv_BIM = mean(c(F.B.cv_BIM, F.C.cv_BIM, F.G.cv_BIM, F.P.cv_BIM),
                      na.rm=TRUE),
    F.A.cv_BM = mean(c(F.B.cv_BM, F.C.cv_BM, F.G.cv_BM, F.P.cv_BM),
                     na.rm=TRUE),
    # Spring
    S.F.cv_BIM = mean(c(S.B.cv_BIM, S.C.cv_BIM, S.G.cv_BIM), na.rm=TRUE),
    S.F.cv_BM = mean(c(S.B.cv_BM, S.C.cv_BM, S.G.cv_BM), na.rm=TRUE),
    S.A.cv_BIM = mean(c(S.B.cv_BIM, S.C.cv_BIM, S.G.cv_BIM, S.P.cv_BIM),
                      na.rm=TRUE),
    S.A.cv_BM = mean(c(S.B.cv_BM, S.C.cv_BM, S.G.cv_BM, S.P.cv_BM),
                     na.rm=TRUE))

save(temp_cv, file="~/Dropbox/Projects/Sev/Plants/Data/Biomass/sev_plant_CV.RData")
```


```{r Old NPP Prelim}
npp.raw <- read_excel(path="~/Dropbox/Projects/Sev/Plants/Data/Biomass/Jen's CV Files/NPPCV.xlsx", 
                      na=c("", "NA"))
npp <- npp.raw %>%
  filter(season %in% 3 & is.sp) %>% # both seaons, exclude trait-group summaries
  
  # make data wide format -- one row per species 
  as.data.table() %>%
  dcast(form = kartez + family + genus + species + path + a_p + g_f + apgf + native ~ biome,
        value.var= c("sum_t", "mean_t", "SD_t", "CV_t", "mean_s", "SD_s", "CV_s"),
        fill=0) %>%
  as.tibble() %>%
  mutate_at(vars(family, path:native ), as.factor) %>%
  
  # add CV data averaging across sites for all sites and flats only
  rowwise() %>% mutate(CV_t_all=mean(c(CV_t_B, CV_t_C, CV_t_G, CV_t_P)),
                       CV_t_flats=mean(c(CV_t_B, CV_t_C, CV_t_G))) %>%
  rowwise() %>% mutate(sum_t_all=sum(c(sum_t_B, sum_t_C, sum_t_G, sum_t_P)),
                       sum_t_flats=sum(c(sum_t_B, sum_t_C, sum_t_G))) %>%
  arrange(genus, species) # sort the tibble

```
