---
title: "Sev Plant Summary"
author: "Tim Farkas"
date: "4/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

##### Collected Samples
```{r Collected Prelim & Summary}
sd <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Samples/sev_plant_traits_collected_samples_2017.xlsx", 
                 sheet=1) %>%
  mutate_at(vars(kartez), as.factor) 
```

##### Individual-Level Data

```{r}
##### samples #####
samp <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Samples/sev_plant_traits_collected_samples_2017.xlsx", 
                 sheet=1) %>%
  mutate_at(vars(kartez), as.factor) %>%
  select(code, kartez, site)

##### leaf data #####
# leaf area
lf_area <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Leaves/sev_leaf_area_2017-18.xlsx", sheet=1) %>% 
  group_by(code) %>%
  summarise(lf_sum_area=sum(area), 
            lf_n_pieces = max(n_pieces),
            lf_whole_ind = as.logical(max(leaves))) 

# leaf mass
lf_mass <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Leaves/sev_leaf_masses_2017-18.xlsx", sheet=1) %>%
  rename(lf_wet_mass = wet, 
         lf_dry_mass = dry,
         lf_petiole_ind = petiole)

# leaf isotopes
lf_iso <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Isotopes/sev_plant_isotopes_2017-18.xlsx", sheet=1) %>%
  select(code = id, mass:cn)

##### Stems and Roots #####

st_rt <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/sev_stem_root_data_2017-18.xlsx", sheet=1) %>%
  mutate_at(vars(code), funs(substr(., 2, nchar(.)))) # remove leading "p"

fr_shp <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/Specific Root Length/Measurements/fine_root_shapes_2017-18.xlsx") %>%
  mutate_at(vars(code), funs(as.character(.)))

fr_mass <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/fine_root_mass.xlsx") %>%
  mutate_at(vars(code), funs(as.character(.)))

##### Seed Mass #####

seed_mass <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Seeds/sev_seed_masses.xlsx") %>% 
  filter(include=="T") %>% # went through all photos and identified samples to exclude (immature, not seeds, etc.)
  select(code, seed_mass_sum=mass, seed_n=count)
##### Join #####

indv_data <- samp %>%
  left_join(lf_area, by = "code") %>%
  left_join(lf_mass, by = "code") %>%
  left_join(lf_iso , by = "code") %>%
  left_join(st_rt  , by = "code") %>%
  left_join(fr_shp , by = "code") %>%
  left_join(fr_mass, by = "code") %>%
  left_join(seed_mass, by = "code") %>%
  write_csv(path = "~/Dropbox/Projects/Sev/Plants/Data/All Traits/indv_samp_traits_2017-18.csv")
  
  
  

```


##### Biomass and CV
```{r Input/Modify/Explore Raw Biomass Data}
## Input raw data
ab.raw <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/Biomass/Sevilleta_allbiomass_28Jan2018.csv")

## modify data
ab <- ab.raw %>%
  filter(substr(site, 1, 4) == "core", treatment == "C") %>%
  mutate_at(vars(year), funs(paste("y", year, sep=""))) %>%
  mutate_at(vars(kartez), funs(ifelse(. %in% c("ARDI5", "ARPU9"), "ARIST", 
                                      ifelse(. %in% c("SPCO4", "SPFL", "SPCR"),
                                             "SPORO", ifelse(. == "OESU3", "GACO5", 
                                                             ifelse(. == "OESUN", "GASUN", 
                                                                    ifelse(. == "DYGR", "CHGR2", 
                                                                           ifelse(. %in% c("ASFE2", "ASNU4", "ASTRA"), "ASTRA", .)))))))) %>%
  mutate_at(vars(site, year, season, web:kartez, treatment), funs(as.factor(.))) %>%
  mutate_at(vars(site), 
            funs(fct_recode(., "G" = "core_black", "C" = "core_creosote", 
                            "B" = "core_blue", "P" = "core_PJ" ))) %>%
  mutate_at(vars(season), 
            funs(fct_recode(., "F" = "fall", "S" = "spring"))) %>%
  select(site:kartez, -treatment, -block, -subplot, biomass.BM:biomass.BIM) %>%
  droplevels()
```

```{r Biomass Exploration}
## raw data xploration

levels(ab$kartez)

## match with traits species
sp.raw <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/All Traits/sev_all_traits_Nov2018.csv") %>% 
  mutate_at(vars(kartez), funs(as_factor(.)))

quad.raw <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/Biomass/NPP_quad_20181105.csv") %>% 
  mutate_at(vars(Species), funs(as_factor(.)))

# missing 35 species from biomass file, but not from quad data
# probably a bug in the allometry code, but not sure
intersect(sp.raw$kartez, levels(ab$kartez))
setdiff(sp.raw$kartez, levels(ab$kartez))
setdiff(levels(ab$kartez), sp.raw$kartez)
setdiff(sp.raw$kartez, levels(quad.raw$Species))
setdiff(levels(quad.raw$Species), sp.raw$kartez)
```

```{r Make CV data}
temp_cv <- ab %>%
  group_by(site, year, season, kartez) %>%
  summarize(density_BM = sum(biomass.BM) / n(),
            density_BIM = sum(biomass.BIM) / n()) %>%
  complete(kartez, nesting(year, season, site), fill=list(density_BM = 0, 
                                                          density_BIM = 0)) %>%
  ungroup() %>% group_by(site, season, kartez) %>%
  summarize(cv_BM = sd(density_BM)/mean(density_BM),
            cv_BIM = sd(density_BIM)/mean(density_BIM)) %>%
  ungroup() %>%
  replace(is.na(.), NA) %>%
  gather(key = "cv_type", value = "density", starts_with("cv")) %>%
  unite(col = season_site_cv, season, site, cv_type, sep=".") %>%
  spread(key=season_site_cv, value=density) %>%
  rowwise() %>%
  mutate(# Fall Flats only average, Fall All sites average
    F.F.cv_BIM = mean(c(F.B.cv_BIM, F.C.cv_BIM, F.G.cv_BIM), na.rm=TRUE),
    F.F.cv_BM = mean(c(F.B.cv_BM, F.C.cv_BM, F.G.cv_BM), na.rm=TRUE),
    F.A.cv_BIM = mean(c(F.B.cv_BIM, F.C.cv_BIM, F.G.cv_BIM, F.P.cv_BIM),
                      na.rm=TRUE),
    F.A.cv_BM = mean(c(F.B.cv_BM, F.C.cv_BM, F.G.cv_BM, F.P.cv_BM),
                     na.rm=TRUE),
    # Spring
    S.F.cv_BIM = mean(c(S.B.cv_BIM, S.C.cv_BIM, S.G.cv_BIM), na.rm=TRUE),
    S.F.cv_BM = mean(c(S.B.cv_BM, S.C.cv_BM, S.G.cv_BM), na.rm=TRUE),
    S.A.cv_BIM = mean(c(S.B.cv_BIM, S.C.cv_BIM, S.G.cv_BIM, S.P.cv_BIM),
                      na.rm=TRUE),
    S.A.cv_BM = mean(c(S.B.cv_BM, S.C.cv_BM, S.G.cv_BM, S.P.cv_BM),
                     na.rm=TRUE))

save(temp_cv, file="~/Dropbox/Projects/Sev/Plants/Data/Biomass/sev_plant_CV.RData")
```


```{r Old NPP Prelim}
npp.raw <- read_excel(path="~/Dropbox/Projects/Sev/Plants/Data/Biomass/Jen's CV Files/NPPCV.xlsx", 
                      na=c("", "NA"))
npp <- npp.raw %>%
  filter(season %in% 3 & is.sp) %>% # both seaons, exclude trait-group summaries
  
  # make data wide format -- one row per species 
  as.data.table() %>%
  dcast(form = kartez + family + genus + species + path + a_p + g_f + apgf + native ~ biome,
        value.var= c("sum_t", "mean_t", "SD_t", "CV_t", "mean_s", "SD_s", "CV_s"),
        fill=0) %>%
  as.tibble() %>%
  mutate_at(vars(family, path:native ), as.factor) %>%
  
  # add CV data averaging across sites for all sites and flats only
  rowwise() %>% mutate(CV_t_all=mean(c(CV_t_B, CV_t_C, CV_t_G, CV_t_P)),
                       CV_t_flats=mean(c(CV_t_B, CV_t_C, CV_t_G))) %>%
  rowwise() %>% mutate(sum_t_all=sum(c(sum_t_B, sum_t_C, sum_t_G, sum_t_P)),
                       sum_t_flats=sum(c(sum_t_B, sum_t_C, sum_t_G))) %>%
  arrange(genus, species) # sort the tibble

```

##### Leaves
```{r SLA Data Prelim & Manipulation}

# load raw data
ad <- read_excel("~/Dropbox/Projects/Sev/Plants/data/Leaves/sev_leaf_area_2017-18.xlsx")
md <- read_excel("~/Dropbox/Projects/Sev/Plants/data/Leaves/sev_leaf_masses_2017-18.xlsx",
                 na="NA")

# merge datasets and make new variables
ld <- dcast(ad, formula= ... ~ ., value.var = "area", fun.aggregate = sum) %>%
  rename(area = ".") %>%
  left_join(md, "code") %>%
  left_join(sd[c("kartez", "sla_code")], by=c("code" = "sla_code")) %>%
  select(kartez, code, file, n_pieces:petiole) %>%
  as.tibble() %>%
  mutate(ldmc = dry / wet, sla= area / dry, lma= 1 / sla, 
         avg_area = if_else(leaves, area/n_pieces, as.double(NA))) %>%
  group_by(kartez)

ld_ag <- ld %>%
  summarise_at(vars(ldmc, sla, lma, area), mean, na.rm=TRUE) %>%
  mutate_at(vars(area), funs(ifelse(is.nan(.), NA, .)))

```

##### Stems and Taproots
```{r Stem / Root Data Prelim & Manipulation}

srd.raw <- read_xlsx("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/sev_stem_root_data_2017-18.xlsx",
                     sheet=1,
                     na="NA")

# QC

sum(is.na(srd.raw$stm_dry2) & !is.na(srd.raw$stm_dry1)) # 0
sum(is.na(srd.raw$rt_dry2) & !is.na(srd.raw$rt_dry1)) # 0

# new variables
srd <- srd.raw %>%
  mutate(sdmc = stm_dry2/stm_wet) %>% # stem dry matter content
  mutate(rdmc = rt_dry2/rt_wet) %>% # taproot dry matter content
  mutate(stm_vol = pi * stm_len * ((stm_d1 / 2) ^ 2 + (stm_d1 / 2) * # stem volume
                                     (stm_d2 / 2) + (stm_d2/2) ^ 2) / 3) %>%
  mutate(sdens = stm_dry2/stm_vol) %>% # stem density
  mutate(rt_vol = pi * rt_len * ((rt_d1 / 2) ^ 2 + (rt_d1 / 2) * # taproot volume
                                   (rt_d2 / 2) + (rt_d2/2) ^ 2) / 3) %>%
  mutate(rdens = rt_dry2/rt_vol) %>% # taproot density
  mutate_at(vars(code), # remove preceding "p" from code
            .funs= function(x) substr(.$code, 
                                      2, 
                                      nchar(.$code))) %>%
  left_join(sd %>% select(kartez, rt_stm_code), # get spp. codes with merge
            by=c("code" = "rt_stm_code")) %>%
  filter(code != "325A" & (rdmc < 1 | is.na(rdmc))) %>% # sample with unknown spp. id & 2 exrtreme root densities
  mutate_at(vars(stm_wet:rdens), funs(if_else(is.nan(.), as.numeric(NA), .))) %>%
  group_by(kartez)

srd_ag <- srd %>%
  summarize_at(vars(sdmc, rdmc, sdens, rdens), mean, na.rm=TRUE)
```

##### Specific Root Length
```{r SRL Preliminary}

## Input SmartRoot data
files <- list.files("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/Specific Root Length/Measurements/")
codes <- substr(files, 8, 10)

## Input root mass data
rmd <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/fine_root_mass.xlsx") %>%
  mutate(frdmc = dry / wet) %>%
  mutate_at(vars(code), funs(as.character(.)))

rd1 <- setNames(lapply(files, function(x) {
  
  rds <- read.csv(paste("~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/Specific Root Length/Measurements/", x, sep=""))
  return(data.frame(length=rds$length, 
                    diam=rds$diameter, 
                    vol=rds$volume))
  rm(rds)
}
), codes)

rd.raw <- do.call(rbind, lapply(rd1, function(x) {
  
  c(len=sum(x$length), diam=quantile(x$diam, .95), vol=sum(x$vol))
  
})) %>%
  as.data.frame() %>%
  mutate("code" = row.names(.)) 

#write_csv(rd.raw, path = "~/Dropbox/Projects/Sev/Plants/Data/Roots and Stems/Specific Root Length/Measurements/fine_root_shapes_2017-18.csv")


rd <- rd.raw %>%
  left_join(sd[, c("kartez", "code")], by="code") %>%
  left_join(rmd, by="code") %>%
  select(code, kartez, len:frdmc) %>%
  rename(diam = "diam.95%") %>%
  mutate(srl = dry / len, 
         frdens = dry/vol) %>%
  droplevels() %>%
  group_by(kartez)

srl_ag <- rd %>% 
  summarize(fr.diam = mean(diam),
            fr.dmc = mean(frdmc), 
            fr.srl = mean(srl), 
            fr.dens = mean(frdens))

```

##### Isotopes
```{r Isotope Data}
cnd <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Isotopes/sev_plant_isotopes_2017-18.xlsx") %>%
  select(-(tray:tray_id)) %>%
  left_join(sd, c("id" = "sla_code")) %>%
  select(kartez, id, site, mass:cn) %>%
  group_by(kartez)

cnd_ag <- cnd %>%
  summarize_at(vars(d15N, d13C, pN, pC, cn), mean, na.rm=TRUE)

```

##### Seeds
```{r}
sed <- read_excel("~/Dropbox/Projects/Sev/Plants/Data/Seeds/sev_seed_masses.xlsx") %>%
  mutate(seed_mass = mass/count) %>%
  filter(include == "T")

sed_ag <- sed %>%
  mutate(seed_mass = mass/count) %>%
  group_by(kartez) %>%
  summarize(count = sum(count), 
            mass = sum(mass),
            sd = sd(seed_mass),
            cv = sd/mean(seed_mass),
            samples = n()) %>%
  mutate(seed_mass = mass / count) %>%
  arrange(desc(seed_mass)) %>%
  select(kartez, seed_mass)

sed_ag

# sed_ag %>%
#   ggplot() + 
#   geom_histogram(aes(x=sd))

sed %>% 
  filter(kartez == "CINE")

```

##### Height
```{r Height Data Input and Manipulation}

# load quadrat data for flats and PJ

qdf <- read.csv("~/Dropbox/Projects/Sev/Plants/data/Biomass/sev129_nppcorequadrat_20170621.csv")

qdp <- read.csv("~/Dropbox/Projects/Sev/Plants/data/Biomass/sev278_npppinjquadrat_20161214.csv") %>%
  rename(web = plot, plot = transect)

nas <- c("-888", "-999", -888, -999, "NONE") # na values

# manipulate quadrat data for height calculations
qd <- rbind(qdf, qdp) %>%
  select(c("year", "season", "site", "species", "obs", "height", "count", "comment")) %>%
  rename(kartez = species) %>%
  filter(season == 3) %>%
  mutate_all(funs(replace(., . %in% nas, NA))) %>%
  mutate_at(vars(kartez), funs(replace(., . == " BREUC2", "BREUC2"))) %>%
  mutate_at(vars(kartez), funs(replace(., . == "ecfef3", "ECFEF3"))) %>%
  droplevels()

# get height data aggregates

hdI <- qd %>% # all sites separately 
  group_by(kartez, site) %>%
  filter(count > 0) %>%
  summarize(n_obs = sum(count, na.rm=TRUE),
            avg.height = sum(count * height, na.rm=TRUE)/sum(count, na.rm=TRUE),
            max.height = max(height, na.rm=TRUE), 
            p95.height = quantile(height, .95, na.rm=TRUE))

hdA <- qd %>% # all sites pooled
  group_by(kartez) %>%
  filter(count > 0) %>%
  summarize(n_obs = sum(count, na.rm=TRUE),
            avg.height = sum(count * height, na.rm=TRUE)/sum(count, na.rm=TRUE),
            max.height = max(height, na.rm=TRUE), 
            p95.height = quantile(height, .95, na.rm=TRUE)) %>%
  mutate(site = as.factor("A")) %>%
  select(1, site, 2:5)

hdF <- qd %>% # flats only
  filter(site != "P") %>%
  group_by(kartez) %>%
  filter(count > 0) %>%
  summarize(n_obs = sum(count, na.rm=TRUE),
            avg.height = sum(count * height, na.rm=TRUE)/sum(count, na.rm=TRUE),
            max.height = max(height, na.rm=TRUE), 
            p95.height = quantile(height, .95, na.rm=TRUE)) %>%
  mutate(site=as.factor("F")) %>%
  select(1, site, 2:5)

# combine heights from site sets and make wide format

hd_ag <- bind_rows(hdA, hdF, hdI) %>%
  mutate_at(vars(site), as.factor) %>%
  as.data.table() %>%
  dcast(form = kartez ~ site,
        value.var= c("avg.height", "max.height", "p95.height"),
        fill=NA) %>%
  as_tibble() 

# QC

ggplot(data=hd_ag, aes(hd_ag$p95.height_A)) + geom_histogram()

filter(hd_ag, p95.height_A >=150)
```

##### Life History
```{r Add whole plant and taxon data}
allsplst <- read_csv("~/Dropbox/Projects/Sev/Plants/Species /sev_all_spp_list_augmented.csv") %>%
  select(kartez, life_cycle, life_form, native, path, a_p, g_f, apgf) %>%
  mutate_at(vars(2:8), as.factor)

splst <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/All Traits/traits_spp_list.csv")

lhd <- left_join(splst, allsplst, by="kartez") %>% 
  as.tibble() %>%
  mutate(species.old = substr(taxon, regexpr(pattern="_", text=taxon) + 1, nchar(taxon)),
         species.new = substr(new.taxon, regexpr(pattern="_", text=new.taxon) + 1, nchar(new.taxon)),
         genus.old = substr(taxon, 1, regexpr(pattern="_", text=taxon) - 1),
         genus.new = substr(new.taxon, 1, regexpr(pattern="_", text=new.taxon) - 1)) %>%
  droplevels() %>%
  select(kartez, family, genus.old, genus.new, species.old, species.new, 
         taxon.old=taxon, taxon.new=new.taxon, life_cycle:apgf)

```

##### Combine Trait Data

```{r}

# all samples data
ad <- sd %>% ungroup() %>%
  left_join(select(ld %>% ungroup(), code, n_pieces:avg_area) , by=c("sla_code" = "code")) %>%
  left_join(select(srd %>% ungroup(), -kartez), by=c("rt_stm_code" = "code")) %>%
  left_join(select(rd %>% ungroup(), -kartez), by="code") %>%
  left_join(select(cnd %>% ungroup(), -kartez, -site), by=c("sla_code" = "id")) 

# data aggregated by species  

ad_ag <- reduce(list(lhd, hd_ag, ld_ag, cnd_ag, srd_ag, srl_ag, sed_ag), 
                left_join, 
                by="kartez") %>%
  mutate_at(vars(avg.height_A:seed_mass), round, digits=4)

comp_ad <- ad_ag %>% 
  select(ldmc:seed_mass) %>% 
  complete.cases() %>%
  sum()


# write.csv(ad_ag, file="~/Dropbox/Projects/Sev/Plants/Data/All Traits/sev_all_traits_Nov2018.csv", row.names=FALSE)
```

##### Modify Trait Data For Analysis and Merge with CV Data
```{r}
raw_traits <- read_csv("~/Dropbox/Projects/Sev/Plants/Data/All Traits/sev_all_traits_Nov2018.csv") %>%
  filter(! kartez %in% c("DAJA?")) %>%
  mutate_at(vars(kartez), funs(ifelse(. == "ARPU9", "ARIST", .))) %>%
  mutate_at(vars(kartez), funs(ifelse(. %in% c("SPCO4", "SPFL2"), "SPORO", .))) %>%
  mutate_at(vars(kartez), funs(ifelse(. %in% c("ASFE2", "ASNU4"), "ASTRA", .))) %>%
  mutate_at(vars(a_p), funs(ifelse(. == "a", 0, 1))) %>%
  group_by(kartez) 

load(file="~/Dropbox/Projects/Sev/Plants/Data/Biomass/sev_plant_CV.RData")

all_traits <- 
  inner_join(raw_traits %>% summarize_at(vars(family:apgf, -a_p), funs(max)),
             raw_traits %>% summarize_at(vars(a_p, avg.height_A:seed_mass), funs(mean)), 
             by = "kartez") %>%
  inner_join(temp_cv, by="kartez") %>%
  mutate_at(vars(lma), funs(ifelse(. > 0.1, NA, .))) %>%
  mutate_at(vars(p95.height_A), funs(ifelse(. > 100, NA, .))) %>%
  mutate_at(vars(sdens), funs(ifelse(. > 0.003, NA, .))) %>%
mutate_at(vars(rdens), funs(ifelse(. > 0.003, NA, .))) %>%
  mutate_at(vars(fr.diam), funs(ifelse(. > 0.15, NA, .))) 


```

##### Basic traits exploration
```{r}

ggplot(all_traits) + 
  geom_histogram(aes(x=seed_mass))

ad2 <- ad_ag %>%
  select(a_p, p95.height_A, ldmc, lma, area, cn, sdmc:rdens) %>%
  mutate_at(vars(a_p), as.numeric) %>%
  filter(p95.height_A < 150, lma < .09, rdens < .002, cn < 60)

ggplot(data=ad2, aes(ad2$cn)) + geom_histogram()
filter(ad2, p95.height_A > 100)

ggpairs(ad2)
```

#### PICs

pics() function takes x = a data frame, cols = a character vector of column names, phy = a tree file, center = logical to mean center all PICs, and a print.tree = logical whether to print the phylogeny. pics() returns a data frame with PICs for each variable, and automatically includes only complete cases across cols. 

```{r pics() Function}

pics.old <- function(x, cols=NULL, phy=tree158, taxa="taxon", center=TRUE, print.tree=FALSE)  {
  
  require(ape)
  x <- as.data.frame(x)
  x <- x[!is.na(x[[taxa]]), ]
  tip.names <- x[[taxa]]
  
  phy$node.label <- paste("node", 1:phy$Nnode)
  
  if(is.null(cols)) dd <- x[ , colnames(x) != taxa, drop=FALSE] else dd <- x[ , cols[cols != taxa], drop=FALSE] 
  
  rownames(dd) <- tip.names
  dd <- dd[complete.cases(dd), , drop=FALSE] # get only data with mutually complete records
  
  # prune data and tree
  dd <- dd[rownames(dd) %in% intersect(rownames(dd), phy$tip.label), , drop=FALSE] # prune data
  pruned <- drop.tip(phy, setdiff(phy$tip.label, rownames(dd))) # prune tree
  if(!setequal(pruned$tip.label, rownames(dd))) # check that taxa match
    return("ERROR: tree and trait taxa do not match")
  pruned <- multi2di(pruned, random=FALSE) # resolve multifurcations with branches of zero length
  # pruned$node.label <- 1:pruned$Nnode # add node labels
  if(print.tree) {
    plot.phylo(pruned, show.node.label = TRUE, cex=.5, adj=0, 
               use.edge.length = FALSE)
  }
  # pruned$node.label <- paste("node", 1:pruned$Nnode) # add better node labels
  
  picmat <- as.data.frame(sapply(dd, function(y) pic(y, pruned))) # make PIC data for all columns
  if(center) picmat <- as.data.frame(t(t(picmat) - colMeans(picmat))) # mean center
  return(picmat)
  
}



```

```{r Better pics() function}
pics <- function(x, # a tibble or data frame with trait data
                 cols=NULL, # a character string of trait columns
                 phy, # a phylogenetic tree of class "phylo" & order "cladewise"
                 taxa, # a character string of the taxon column, to match tips in phy
                 center=TRUE, 
                 scale=TRUE) { # logical indicator whether to mean center PIC output
  
  require(ape)
  require(dplyr)
  require(geiger)
  

  # format data frame input
  dd <- x %>% 
    as.tibble() %>% # coerce to tibble
    rename(taxon = taxa) %>% # identify taxon column
    filter(!is.na(taxon)) # remove NA taxa
  
  # specify all columns if none given by user
  if(is.null(cols)) cols <- names(dd %>% select(-taxon)) 
  
  # prune tree for matches only
  phy <- drop.tip(phy, setdiff(phy$tip.label, dd$taxon))
  phy <- multi2di(phy, random=FALSE) 
  phy$node.label <- paste("node", 
                          formatC(c(1:phy$Nnode), 
                                  digits=0, width=nchar(phy$Nnode), flag="0"))
  
  # get single PICs function
  pic1 <- function(col  # 2 column data frame or tibble with first column taxon, 
                   # second column trait data, possibly with NAs
                   ,  phy
                   ,  scale=scale) {  # a .tre object to patch first column of col

    # remove NA and add taxon as rownames for apre::pic 
    col <- col %>% 
      filter(!is.na(.[2])) %>%
      as.data.frame()
    rownames(col) <- col$taxon
    col <- col %>% 
      select(2)
    
    # prune data and tree
    col <- col[rownames(col) %in% intersect(rownames(col), phy$tip.label), 
               , drop=FALSE] 
    pruned <- drop.tip(phy, setdiff(phy$tip.label, rownames(col)))
    
    # resolve multifurcations with branches of zero length
    # pruned <- multi2di(pruned, random=FALSE) 
    
    # get pic column
    pic.out <- pic(col[[1]], pruned, scaled=scale
                   ,var.contrasts=TRUE
                   ) #%>%
    #   tibble(names(.)) %>%
    #   select(2, 1)
    # names(pic.out) <- c("node", names(col))
    
    return(pic.out)
    
  }  
  
  # generate list of pics for all traits 
  pic_list <- lapply(cols, function(y) {
    
    trait <- data.frame(taxon=dd[["taxon"]], dd[[y]])
    names(trait)[2] <- y
    as.data.frame(pic1(col=trait, phy=phy, scale=scale))
    
  })                     
  
  ojoin_list <- function(right) { # recursive joining function
    
    left <- right[1]
    right <- right[-1]
    
    if(length(right) == 0) return(left[[1]])
    print("continued")
    if(length(right) == 1) return(full_join(left[[1]], right[[1]], by="node"))
    
    full_join(left[[1]], ojoin_list(right), by="node")
    
  }
  
  pics_only <- lapply(pic_list, 
                      function(x) data.frame(node=rownames(x),
                                                       contrasts=x$contrasts))
  vars_only <- lapply(pic_list, 
                      function(x) data.frame(node=rownames(x), 
                                                       variance=x$variance))
  
  # join list of pics into single data frame, joining on node
  
  if(center) {pics_df <- suppressWarnings(ojoin_list(pics_only)) %>% 
    mutate_at(vars(2:ncol(.)), funs(. - mean(., na.rm=TRUE)))} else
      pics_df <- ojoin_list(pic_list)
  
  vars_df <- suppressWarnings(ojoin_list(vars_only))
  
  names(pics_df) <- c("node", cols)
  names(vars_df) <- c("node", cols)
  
  outlist <- list(pics_df=pics_df[order(pics_df$node), ], 
                  vars_df=vars_df[order(vars_df$node), ])
  
  return(outlist)
  
}
```

```{r Better pics() function with transformation}
pics <- function(x, # a tibble or data frame with trait data
                 cols=NULL, # a character string of trait columns
                 phy, # a phylogenetic tree of class "phylo" & order "cladewise"
                 taxa, # a character string of the taxon column, to match tips in phy
                 center=TRUE, 
                 scale=TRUE) { # logical indicator whether to mean center PIC output
  
  require(ape)
  require(dplyr)
  require(geiger)
  
  # format data frame input
  dd <- x %>% 
    as.tibble() %>% # coerce to tibble
    rename(taxon = taxa) %>% # identify taxon column
    filter(!is.na(taxon)) # remove NA taxa
  
  # specify all columns if none given by user
  if(is.null(cols)) cols <- names(dd %>% select(-taxon)) 
  
  # prune tree for matches only
  phy <- drop.tip(phy, setdiff(phy$tip.label, dd$taxon))
  phy <- multi2di(phy, random=FALSE) 
  phy$node.label <- paste("node", 
                          formatC(c(1:phy$Nnode), 
                                  digits=0, width=nchar(phy$Nnode), flag="0"))
  
  # get single PICs function
  pic1 <- function(col  # 2 column data frame or tibble with first column taxon, 
                   # second column trait data, possibly with NAs
                   ,  phy
                   ,  scale=scale) {  # a .tre object to patch first column of col

    # remove NA and add taxon as rownames for apre::pic 
    col <- col %>% 
      filter(!is.na(.[2])) %>%
      as.data.frame()
    rownames(col) <- col$taxon
    col <- col %>% 
      select(2)
    
    # prune data and tree
    col <- col[rownames(col) %in% intersect(rownames(col), phy$tip.label), 
               , drop=FALSE] 
    pruned <- drop.tip(phy, setdiff(phy$tip.label, rownames(col))) %>%
      compute.brlen()
    
# loop through lambda's for Pagel transformations
    corrs <- vector()
    modpics <- list()
    pvs <- vector()
    trans=vector()
    params=vector()
    
    for (t in c(
                # "allequal", 
                # "grafen",
                "pagel")) {
    
    if(t == "pagel") parms <- seq(0, 1, by=.1) else
      if (t == "grafen") parms <- c(seq(.1, 1, by=.1), seq(1.5, 10, by=.5)) else
        if (t == "allequal") parms <- 1
      
    for (p in parms) {
      
      if(t == "pagel") t.phy <-rescale(x=pruned, model="lambda", p) else
      if (t == "grafen") t.phy <- compute.brlen(phy=pruned, power=p) else
      if (t == "allequal") t.phy <- compute.brlen(phy=pruned, runif, min=p, max=p)
    # get pic column
    pic.out <- as.data.frame(pic(col[[1]], t.phy, scaled=scale, var.contrasts=TRUE))
    
    corr <- cor(abs(pic.out[,1]), sqrt(pic.out[,2]))
    test <- cor.test(abs(pic.out[,1]), sqrt(pic.out[,2]))
    
    ggplot() +
      geom_point(aes(x=sqrt(pic.out[,2]), y=abs(pic.out[,1])))
    
    corrs <- c(corrs, abs(corr))
    modpics <- c(modpics, list(pic.out))
    pvs <- c(pvs, test$p.value)
    trans <- c(trans, t)
    params <- c(params, p)
    
    }
  }
    
    pic.out.l <- list(pics = modpics[corrs == min(corrs)][[1]], 
                      trans = trans[corrs == min(corrs)],
                      parm=params[corrs == min(corrs)],
                      corr = min(corrs),
                      pvalue = pvs[corrs == min(corrs)])
    return(pic.out.l)
    
    }  
    
  
  # generate list of pics for all traits 
  pic_list <- lapply(cols, function(y) {
    
    trait <- data.frame(taxon=dd[["taxon"]], dd[[y]])
    names(trait)[2] <- y
    pic1(col=trait, phy=phy, scale=scale)
    
  })                     
  
  ojoin_list <- function(right, left) { # recursive joining function
    
    left <- right[1]
    right <- right[-1]
    
    if(length(right) == 1) return(full_join(left[[1]], right[[1]], by="node"))
    
    full_join(left[[1]], ojoin_list(right), by="node")
    
  }
  
  pics_only <- lapply(pic_list, function(x) data.frame(node=rownames(x$pics), contrasts=x$pics$contrasts))
  vars_only <- lapply(pic_list, function(x) data.frame(node=rownames(x$pics), variance=x$pics$variance))

  
  # join list of pics into single data frame, joining on node
  
  if(center) {pics_df <- suppressWarnings(ojoin_list(pics_only)) %>% 
    mutate_at(vars(2:ncol(.)), funs(. - mean(., na.rm=TRUE)))} else
      pics_df <- ojoin_list(pic_list)
  
  vars_df <- suppressWarnings(ojoin_list(vars_only))
  
  names(pics_df) <- c("node", cols)
  names(vars_df) <- c("node", cols)
  
  outlist <- list(pics_df=pics_df[order(pics_df$node), ], 
                  vars_df=vars_df[order(vars_df$node), ],
                  parms = data.frame(trait=cols,
                                     trans=sapply(pic_list, function(x) x$trans),
                                     parms=sapply(pic_list, function(x) x$parm),
                                     corrs=sapply(pic_list, function(x) x$corr),
                                     pvs = sapply(pic_list, function(x) x$pvalue)))
  
  return(outlist)
  
}
```

```{r PICs Function Testing}

## pic1 function

# specify variables
col <- sp.raw %>% select(taxon.new, cn)
phy <- my_phy <- read.tree(file = "~/Dropbox/Projects/Sev/Plants/Plant Phylogenies/sev_traits_tree101.tre")


pic1 <- function(col, phy) {
  
  phy$node.label <- paste("node", 1:phy$Nnode)
  
  # remove NA but keep rownames
  col <- col %>% 
    filter(!is.na(.[2])) %>%
    as.data.frame()
  rownames(col) <- col$taxon
  col <- col %>% 
    select(2)
  
  # prune data and tree
  col <- col[rownames(col) %in% intersect(rownames(col), phy$tip.label), , drop=FALSE] 
  pruned <- drop.tip(phy, setdiff(phy$tip.label, rownames(col)))
  
  # if(!setequal(pruned$tip.label, rownames(col))) # check that taxa match
  # return("ERROR: tree and trait taxa do not match")
  
  # resolve multifurcations with branches of zero length
  pruned <- multi2di(pruned, random=FALSE) 
  
  # get pic column
  pic.out <- pic(col[[1]], pruned) %>%
    tibble(names(.)) %>%
    select(2, 1)
  names(pic.out) <- c("node", names(col))
  
  return(pic.out)
  
} 

## make list of pics to feed to pic1

pic_list <- lapply(cols, function(x) {
  
  trait <- data.frame(taxon=dd[["taxon"]], dd[[x]])
  names(trait)[2] <- x
  pic1(col=trait, phy=my_phy)
  
})   
## whole function
cols

pics_out <- pics(x = sp.raw, cols=cols, taxa="taxon.new", phy=my_phy, center=TRUE)
```

```{r Create PICs}
library(geiger)

my_phy <- read.tree(file = "~/Dropbox/Projects/Sev/Plants/Plant Phylogenies/sev_traits_tree101.tre") 

# no transform
phy_in <- my_phy
  thepics <- pics(x = all_traits, cols=c("a_p") , phy=phy_in, taxa="taxon.new", scale=TRUE)
  print(ggplot() + 
    geom_point(aes(x=sqrt(thepics$vars_df[,trait]), y=abs(thepics$pics_df[,trait]))))

# grafen
rho=1
phy_in <- compute.brlen(my_phy, power=rho)
  thepics <- pics(x = all_traits, cols=c("a_p", "ldmc") , phy=phy_in, taxa="taxon.new", scale=TRUE)
  print(ggplot() + 
    geom_point(aes(x=sqrt(thepics$vars_df[,trait]), y=abs(thepics$pics_df[,trait]))))
 
# lambda (Pagel?) 
lambda=0
phy_in <- rescale(my_phy, "lambda", lambda)
  thepics <- pics(x = all_traits, cols=c("a_p", "ldmc") , phy=phy_in, taxa="taxon.new", scale=TRUE)
  print(ggplot() + 
    geom_point(aes(x=sqrt(thepics$vars_df[,trait]), y=abs(thepics$pics_df[,trait]))))
```

```{r}

my_phy <- read.tree(file = "~/Dropbox/Projects/Sev/Plants/Plant Phylogenies/sev_traits_tree101.tre") %>%
  compute.brlen(1)
my_phy$edge.length


# try different functions
for(trait in c("a_p", "ldmc", "lma", "cn")) {


parms_df <- do.call(rbind, pic_list <- lapply(seq(0.05, 1, by=0.05), function(rho) {
  
    phy_in <- compute.brlen(my_phy, "Grafen", power=rho)
    # phy_in <- compute.brlen(my_phy, 1)
  thepics <- pics(x = all_traits, cols=trait, phy=phy_in, taxa="taxon.new", scale=TRUE)
  data.frame(transform="grafen", param=rho, node=thepics$pics_df[[1]], 
             pics=thepics$pics_df[[2]], variance=thepics$vars_df[[2]])
  
}))

pdf_path <- paste("~/Dropbox/Projects/Sev/Plants/Figures/", 
                  trait, "_brlen.pdf", sep="")

pdf(file = pdf_path)

tplot <- parms_df %>%
  as.tibble() %>%
ggplot(aes(x=sqrt(variance), y=abs(pics))) + 
    geom_point() + 
    geom_smooth(method = "loess", colour = "red", fill = "red") +
    facet_wrap(~ param, scales="free")

print(tplot)

dev.off()

}



# piccorrs <- do.call(rbind,lapply(pic_list, function(df) {
#   data.frame(param=max(df$param), cor=cor(x=sqrt(df$variance), 
#                                               y=abs(df$pics)))}))
```


```{r Evol Models}
## test evolutionary models
my_phy <- read.tree(file = "~/Dropbox/Projects/Sev/Plants/Plant Phylogenies/sev_traits_tree101.tre") %>%
  compute.brlen() %>% multi2di(random=FALSE) 

lambdaopt <- vector()
for (t in names(all_pics$pics_df[2:ncol(all_pics$pics_df)])) {
  
ldmcdat <- as.data.frame(all_traits[t])
rownames(ldmcdat) <- all_traits$taxon.new
lambdatest <- fitContinuous(phy=my_phy, dat=ldmcdat, model="lambda")
lambdaopt <- c(lambdaopt, lambdatest$opt$lambda)

}

deltaopt <- vector()
for (t in names(all_pics$pics_df[2:ncol(all_pics$pics_df)])) {
  
ldmcdat <- as.data.frame(all_traits[t])
rownames(ldmcdat) <- all_traits$taxon.new
deltatest <- fitContinuous(phy=my_phy, dat=ldmcdat, model="delta")
deltaopt <- c(deltaopt, deltatest$opt$delta)

}

kappaopt <- vector()
for (t in names(all_pics$pics_df[2:ncol(all_pics$pics_df)])) {
  
ldmcdat <- as.data.frame(all_traits[t])
rownames(ldmcdat) <- all_traits$taxon.new
kappatest <- fitContinuous(phy=my_phy, dat=ldmcdat, model="OU")
kappaopt <- c(kappaopt,kappatest$opt$kappa)

}

ouopt <- vector()
for (t in names(all_pics$pics_df[2:ncol(all_pics$pics_df)])) {
  
ldmcdat <- as.data.frame(all_traits[t])
rownames(ldmcdat) <- all_traits$taxon.new
outest <- fitContinuous(phy=my_phy, dat=ldmcdat, model="BM")
ouopt <- c(ouopt,kappatest$opt$kappa)

}

```



##### PCAs
```{r PCA on PICs}

ccd <- all_pics.noscale %>%
  select(node, a_p, p95.height_A, ldmc:seed_mass, -sla) %>%
  filter(complete.cases(.)) 

pca.out <- ccd %>%
  select(-node) %>%
  prcomp(scale=TRUE)

plot(summary(pca.out)$importance[3,])
biplot(pca.out, choices=c(1, 2))

# combine with cv data
pca.all <- ccd %>% 
  select(node) %>%
  cbind(pca.out$x) %>%
  as.tibble() %>%
  inner_join(all_pics.noscale, by="node")
```

```{r Analysis with PICs}

ggplot(pca.all, aes(x=seed_mass)) +
  geom_histogram()

pca.all %>% filter( seed_mass > .002)
n3 <- extract.clade(phy, node="node 70")
plot.phylo(n3, show.node.label = TRUE)

pca.all %>% filter(!node %in% c("node 55", "node 70")) %>%
ggplot(aes(y=F.A.cv_BIM, x=PC3, label=node)) +
  geom_point() + 
  geom_label(label.size = .01)

an.PC <- lm(F.A.cv_BM ~ PC1 + PC2 + PC3, data=pca.all, subset=!node %in% c("node 55", "node 70"))
summary(an.PC)

an.a_p <- lm(F.A.cv_BM ~ a_p, data=pca.all)
summary(an.a_p)

an.ldmc <- lm(F.A.cv_BM ~ ldmc, data=pca.all)
summary(an.ldmc)

an.sdens <- lm(F.A.cv_BM ~ sdens, data=pca.all)
summary(an.sdens)

an.comb <- lm(F.A.cv_BM ~ ldmc + cn + fr.diam + sdens + seed_mass + a_p, data=pca.all)
summary(an.comb)
```


```{r Write Out Final Traits File}
allagf <- allag[, c("kartez", "family", "genus", 
                    "species", "taxon", "synonym", "native", "g_f", "path", "a_p", 
                    names(allag)[2:3], names(allag)[5:9], # lab measures
                    names(allag)[c(12, 14, 16, 18, 20, 22)], # mean height
                    names(allag)[c(13, 15, 17, 19, 21, 23)], # max height
                    names(allag)[32:63])] # biomass data

allagc <- allagf[!complete.cases(allagf[, c(8:16, 56)]), ]

write.csv(allagf, file="~/Dropbox/Projects/Sev/data/sev_all_traits_Feb2018.csv", 
          row.names=FALSE)
```


